# Maintainer: Samir Benmendil <samir.benmendil[at]gmail[dot]com>
# Contributer: Yochai Gal <yochaigal@gmail.com>

pkgname=supermeatboy
pkgver=20111213b
_pkgver=12132011b
pkgrel=5
pkgdesc="[Humble Bundle 4] Super Meat Boy is a tough as nails platformer where you play as an animated cube of meat."
arch=('i686' 'x86_64')
url="http://www.supermeatboy.com/"
license=('custom')
depends=('openal' 'sdl')
makedepends=('unzip' 'tar')
source=('supermeatboy.desktop')
md5sums=('ceda8cdca2aaff63a9cae2ef7d7cf0d4')
PKGEXT='.pkg.tar'

_archive_md5="e27c7a2506cbf7047f51a2230f7d1b0f"
hotfix_md5='65b4b39f961e7de7a4d0e018690e736d'
_archive="supermeatboy-linux-${_pkgver}-bin"

build() {
  cd ${srcdir}

  if [ ! -f ${_smbarchivelocation}${_archive} ]; then
	  if [ ! -f ${_archive} ] && [ -n "${_humblebundle4key}" ]; then
		rm -f ${_archive}* index.html?key\=${_humblebundle4key}*
		wget http://www.humblebundle.com/?key=${_humblebundle4key}
		wget $(cat index.html?key\=${_humblebundle4key} | grep "${_archive}" | cut -d "'" -f 10)
		mv ${_archive}* ${_archive}
	  elif [ -z "${_humblebundle4key}" ]; then
		echo You can automate the download of the archive using the _humblebundle4key bash variable.
		echo Just add 'export _humblebundle4key\=\<Your key here\>' to \.bashrc
		echo
		echo Otherwise please just place ${_archive} into $(pwd)/
		echo Press Enter to continue
		read -a _unused
	  fi
    wget http://treefort.icculus.org/smb/smb-linux-mesa-hotfix-test.tar.bz2  
  fi
#'

  if [ ! -f ${_smbarchivelocation}${_archive} ]; then
    echo "${_smbarchivelocation}${_archive} not found!"
    return 1
  fi  

  if ! echo "${_archive_md5}  ${_smbarchivelocation}${_archive}" | md5sum -c --quiet; then
    echo "Invalid checksum for ${_smbarchivelocation}${_archive}"
    return 1
  fi

  if ! echo "${hotfix_md5}  ${srcdir}/smb-linux-mesa-hotfix-test.tar.bz2" | md5sum -c --quiet; then
    echo "Invalid checksum for ${srcdir}/smb-linux-mesa-hotfix-test.tar.bz2"
    return 1
  fi

  rm -Rf ${srcdir}/smb/
  unzip -d ${srcdir}/smb/ ${_smbarchivelocation}${_archive} || true

  rm ${srcdir}/smb/data/{amd64,x86}/lib*
  if test "$CARCH" == "i686"; then
    rm -r ${srcdir}/smb/data/amd64
  else
    rm -r ${srcdir}/smb/data/x86
  fi

# Apply hotfix

  mkdir ${srcdir}/hotfix/
  tar -xvf ${srcdir}/smb-linux-mesa-hotfix-test.tar.bz2 -C ${srcdir}/hotfix
  if test "$CARCH" == "i686"; then
     cp -r ${srcdir}/hotfix/x86   ${srcdir}/smb/data/
  else
     cp -r ${srcdir}/hotfix/amd64/ ${srcdir}/smb/data/
  fi

  mkdir -p ${pkgdir}/opt/ ${pkgdir}/usr/share/applications/ \
    ${pkgdir}/usr/bin/
  cp -Tr ${srcdir}/smb/data ${pkgdir}/opt/supermeatboy/
  ln -s /opt/supermeatboy/SuperMeatBoy ${pkgdir}/usr/bin/supermeatboy
  cp ${srcdir}/supermeatboy.desktop ${pkgdir}/usr/share/applications/
  chmod a+r ${pkgdir}/usr/share/applications/supermeatboy.desktop
}

# vim: sts=2 ts=2 sw=2 et
